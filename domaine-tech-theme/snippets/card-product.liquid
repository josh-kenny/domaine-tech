{% comment %}
  This snippet renders a product card for use in collection pages, featured collections, etc.
  It accepts a 'card_product' variable, which should be a Shopify product object.
{% endcomment %}

{%- if card_product and card_product != blank -%}
  <div class="group relative bg-white rounded-lg p-4 transition-shadow duration-300 hover:shadow-lg">
    {%- if card_product.featured_media -%}
      {% comment %}
        Product image container with hover effect
      {% endcomment %}
      <div class="relative aspect-square overflow-hidden rounded-lg mb-4 product-card-image-container">
        <a href="{{ card_product.url }}" class="block w-full h-full">
          {% comment %}
            Display "On Sale" badge if the product is on sale
          {% endcomment %}
          {%- if card_product.compare_at_price > card_product.price -%}
            <div class="absolute left-2 top-2 z-10">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                On Sale!
              </span>
            </div>
          {%- endif -%}
          
          {% comment %}
            Primary product image
          {% endcomment %}
          <img
            srcset="{% if card_product.featured_media.width >= 165 %}{{ card_product.featured_media | image_url: width: 165 }} 165w,{% endif %}
              {% if card_product.featured_media.width >= 360 %}{{ card_product.featured_media | image_url: width: 360 }} 360w,{% endif %}
              {% if card_product.featured_media.width >= 533 %}{{ card_product.featured_media | image_url: width: 533 }} 533w,{% endif %}
              {% if card_product.featured_media.width >= 720 %}{{ card_product.featured_media | image_url: width: 720 }} 720w,{% endif %}
              {% if card_product.featured_media.width >= 940 %}{{ card_product.featured_media | image_url: width: 940 }} 940w,{% endif %}
              {% if card_product.featured_media.width >= 1066 %}{{ card_product.featured_media | image_url: width: 1066 }} 1066w{% endif %}"
            src="{{ card_product.featured_media | image_url: width: 533 }}"
            sizes="(min-width: 1200px) 267px, (min-width: 990px) calc((100vw - 130px) / 4), (min-width: 750px) calc((100vw - 120px) / 3), calc((100vw - 35px) / 2)"
            alt="{{ card_product.featured_media.alt | escape }}"
            class="w-full h-full object-cover object-center transition-opacity duration-300 primary-image"
            width="{{ card_product.featured_media.width }}"
            height="{{ card_product.featured_media.height }}"
            loading="lazy"
          >

          {% comment %}
            Secondary product image for hover effect
            This image starts hidden (opacity-0) and becomes visible on hover (controlled by CSS)
          {% endcomment %}
          <img
            src="{{ card_product.featured_media | image_url: width: 533 }}"
            srcset="{% if card_product.featured_media.width >= 165 %}{{ card_product.featured_media | image_url: width: 165 }} 165w,{% endif %}
              {% if card_product.featured_media.width >= 360 %}{{ card_product.featured_media | image_url: width: 360 }} 360w,{% endif %}
              {% if card_product.featured_media.width >= 533 %}{{ card_product.featured_media | image_url: width: 533 }} 533w,{% endif %}
              {% if card_product.featured_media.width >= 720 %}{{ card_product.featured_media | image_url: width: 720 }} 720w,{% endif %}
              {% if card_product.featured_media.width >= 940 %}{{ card_product.featured_media | image_url: width: 940 }} 940w,{% endif %}
              {% if card_product.featured_media.width >= 1066 %}{{ card_product.featured_media | image_url: width: 1066 }} 1066w{% endif %}"
            sizes="(min-width: 1200px) 267px, (min-width: 990px) calc((100vw - 130px) / 4), (min-width: 750px) calc((100vw - 120px) / 3), calc((100vw - 35px) / 2)"
            alt="{{ card_product.featured_media.alt | escape }}"
            class="absolute inset-0 w-full h-full object-cover object-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 secondary-image"
            width="{{ card_product.featured_media.width }}"
            height="{{ card_product.featured_media.height }}"
            loading="lazy"
          >
        </a>
      </div>

      {% comment %}
        Color swatch section
        Only show if the product has more than one variant
      {% endcomment %}
      {%- if card_product.has_only_default_variant == false -%}
        {%- liquid
          assign color_option_index = -1
          assign color_option_name = ''
          
          # Find the index of the color option
          for option in card_product.options_with_values
            assign downcased_option = option.name | downcase
            if downcased_option contains 'color' or downcased_option contains 'colour'
              assign color_option_index = forloop.index0
              assign color_option_name = option.name
              break
            endif
          endfor
        -%}
        
        {%- if color_option_index >= 0 -%}
          <div class="js-product-card-color-swatches flex justify-center gap-2 mb-4">
            {%- for value in card_product.options_with_values[color_option_index].values -%}
              {%- liquid
                assign downcased_value = value | downcase
                assign swatch_color_name = downcased_value
                assign variant_image = null
                assign variant_id = nil
                
                # Find the variant that matches this color option
                for variant in card_product.variants
                  assign variant_option = variant.options[color_option_index] | downcase
                  if variant_option == downcased_value and variant.featured_media
                    assign variant_image = variant.featured_media
                    assign variant_id = variant.id
                    break
                  endif
                endfor
              -%}
              
              {%- if variant_image -%}
                <div class="relative">
                  {% comment %}
                    Color swatch input (hidden) and label
                  {% endcomment %}
                  <input 
                    type="radio" 
                    id="Color-{{ section_id }}-{{ card_product.id }}-{{ forloop.index }}" 
                    name="Color-{{ section_id }}-{{ card_product.id }}" 
                    value="{{ value | escape }}"
                    data-variant-image="{{ variant_image.preview_image | image_url }}"
                    data-variant-id="{{ variant_id }}"
                    data-variant-color="{{ value | escape }}"
                    {% if forloop.index == 1 %}checked{% endif %}
                    class="sr-only peer color-swatch"
                  >
                  <label 
                    for="Color-{{ section_id }}-{{ card_product.id }}-{{ forloop.index }}" 
                    class="block w-6 h-6 rounded-full border border-gray-200 cursor-pointer transition-all peer-checked:ring-2 peer-checked:ring-offset-1 peer-checked:ring-black hover:border-gray-300"
                    style="background-color: {{ swatch_color_name | replace: ' ', '' }};"
                    title="{{ value | escape }}"
                  >
                    <span class="sr-only">{{ value }}</span>
                  </label>
                </div>
              {%- endif -%}
            {%- endfor -%}
          </div>
        {%- endif -%}
      {%- endif -%}

      {% comment %}
        Product information section
      {% endcomment %}
      <div class="text-center">
        {% comment %}
          Product vendor (if available)
        {% endcomment %}
        {%- if card_product.vendor -%}
          <p class="text-sm text-gray-600 mb-1">{{ card_product.vendor }}</p>
        {%- endif -%}

        {% comment %}
          Product title
        {% endcomment %}
        <h3 class="text-base font-medium text-gray-900 mb-2">
          <a href="{{ card_product.url }}" class="hover:text-gray-700">
            {{ card_product.title | escape }}
          </a>
        </h3>

        {% comment %}
          Product price
        {% endcomment %}
        <div class="flex justify-center items-baseline gap-2">
          {%- if card_product.compare_at_price > card_product.price -%}
            <span class="text-gray-500 line-through text-sm">{{ card_product.compare_at_price | money }}</span>
          {%- endif -%}
          <span class="text-lg font-medium text-gray-900">{{ card_product.price | money }}</span>
        </div>
      </div>
    {%- endif -%}
  </div>
{% comment %}
  Placeholder for when no product is available
{% endcomment %}
{%- else -%}
  <div class="relative bg-white rounded-lg p-4 transition-shadow duration-300 hover:shadow-lg">
    <div class="aspect-square bg-gray-100 rounded-lg mb-4"></div>
    <div class="text-center">
      <p class="text-sm text-gray-600 mb-1">Sample Brand</p>
      <h3 class="text-base font-medium text-gray-900 mb-2">Product Name</h3>
      <div class="flex justify-center items-baseline">
        <span class="text-lg font-medium text-gray-900">{{ '29.99' | money }}</span>
      </div>
    </div>
  </div>
{%- endif -%}

